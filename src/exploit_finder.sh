#!/bin/bash

# Exploit Finder Module

source src/config.sh

# Exploit finder menu
exploit_menu() {
    clear
    echo -e "${CYAN}"
    cat << "EOF"
╔════════════════════════════════════════════╗
║           EXPLOIT FINDER MODULE           ║
╚════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
    
    echo -e "${CYAN}╔════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║         EXPLOIT FINDING OPTIONS           ║${NC}"
    echo -e "${CYAN}╠════════════════════════════════════════════╣${NC}"
    echo -e "${CYAN}║${NC} 1. ${GREEN}Search Exploits by Service${NC}             ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC} 2. ${GREEN}Search Exploits by CVE${NC}                 ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC} 3. ${GREEN}Check Metasploit Modules${NC}               ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC} 4. ${GREEN}Search Searchsploit${NC}                    ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC} 5. ${GREEN}Back to Main Menu${NC}                      ${CYAN}║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════╝${NC}"
    
    read -p "$(echo -e ${YELLOW}"\n[?] Select option (1-5): "${NC})" choice
    
    case $choice in
        1)
            search_by_service_menu
            ;;
        2)
            search_by_cve_menu
            ;;
        3)
            metasploit_check_menu
            ;;
        4)
            searchsploit_menu
            ;;
        5)
            source quantum.sh
            main_menu
            ;;
        *)
            echo -e "${RED}[!] Invalid option!${NC}"
            sleep 1
            exploit_menu
            ;;
    esac
}

# Search exploits by service
search_by_service_menu() {
    clear
    echo -e "${CYAN}[*] Search Exploits by Service${NC}"
    echo -e "${CYAN}───────────────────────────────${NC}"
    
    echo -e "${YELLOW}Common services:${NC}"
    echo -e "1. Apache"
    echo -e "2. Nginx"
    echo -e "3. MySQL"
    echo -e "4. SSH"
    echo -e "5. FTP"
    echo -e "6. SMB"
    echo -e "7. WordPress"
    echo -e "8. Joomla"
    echo -e "9. Custom service"
    
    read -p "$(echo -e ${YELLOW}"\n[?] Select service (1-9): "${NC})" service_choice
    
    case $service_choice in
        1)
            service="apache"
            ;;
        2)
            service="nginx"
            ;;
        3)
            service="mysql"
            ;;
        4)
            service="ssh"
            ;;
        5)
            service="ftp"
            ;;
        6)
            service="smb"
            ;;
        7)
            service="wordpress"
            ;;
        8)
            service="joomla"
            ;;
        9)
            read -p "$(echo -e ${YELLOW}"[?] Enter service name: "${NC})" service
            ;;
        *)
            echo -e "${RED}[!] Invalid choice!${NC}"
            return
            ;;
    esac
    
    print_status "Searching exploits for: $service" "info"
    
    # Create results directory
    timestamp=$(date +"%Y%m%d_%H%M%S")
    result_dir="$RESULTS_DIR/exploits_${service}_${timestamp}"
    mkdir -p "$result_dir"
    
    # Search for exploits
    search_exploits "$service" "$result_dir"
    
    echo -e "\n${GREEN}[+] Exploit search completed!${NC}"
    echo -e "${GREEN}[+] Results saved in: $result_dir/exploits.txt${NC}"
    
    if [ -f "$result_dir/exploits.txt" ] && [ -s "$result_dir/exploits.txt" ]; then
        echo -e "\n${CYAN}[*] Found Exploits:${NC}"
        echo -e "${CYAN}──────────────────${NC}"
        head -20 "$result_dir/exploits.txt"
    fi
    
    read -p "$(echo -e ${YELLOW}"[?] Press Enter to continue..."${NC})"
    exploit_menu
}

# Search exploits by CVE
search_by_cve_menu() {
    clear
    echo -e "${CYAN}[*] Search Exploits by CVE${NC}"
    echo -e "${CYAN}──────────────────────────${NC}"
    
    read -p "$(echo -e ${YELLOW}"[?] Enter CVE number (e.g., CVE-2021-44228): "${NC})" cve
    
    if [ -z "$cve" ]; then
        echo -e "${RED}[!] CVE cannot be empty!${NC}"
        return
    fi
    
    print_status "Searching exploits for: $cve" "info"
    
    # Create results directory
    timestamp=$(date +"%Y%m%d_%H%M%S")
    result_dir="$RESULTS_DIR/exploits_${cve}_${timestamp}"
    mkdir -p "$result_dir"
    
    # Search for CVE exploits
    search_cve_exploits "$cve" "$result_dir"
    
    echo -e "\n${GREEN}[+] CVE exploit search completed!${NC}"
    echo -e "${GREEN}[+] Results saved in: $result_dir/cve_exploits.txt${NC}"
    
    read -p "$(echo -e ${YELLOW}"[?] Press Enter to continue..."${NC})"
    exploit_menu
}

# Metasploit modules check
metasploit_check_menu() {
    clear
    echo -e "${CYAN}[*] Metasploit Modules Check${NC}"
    echo -e "${CYAN}────────────────────────────${NC}"
    
    read -p "$(echo -e ${YELLOW}"[?] Enter service/application name: "${NC})" app_name
    
    if [ -z "$app_name" ]; then
        echo -e "${RED}[!] Service name cannot be empty!${NC}"
        return
    fi
    
    print_status "Searching Metasploit modules for: $app_name" "info"
    
    # Create results directory
    timestamp=$(date +"%Y%m%d_%H%M%S")
    result_dir="$RESULTS_DIR/metasploit_${app_name}_${timestamp}"
    mkdir -p "$result_dir"
    
    # Check Metasploit modules
    check_metasploit_modules "$app_name" "$result_dir"
    
    echo -e "\n${GREEN}[+] Metasploit module search completed!${NC}"
    echo -e "${GREEN}[+] Results saved in: $result_dir/metasploit_modules.txt${NC}"
    
    read -p "$(echo -e ${YELLOW}"[?] Press Enter to continue..."${NC})"
    exploit_menu
}

# Searchsploit menu
searchsploit_menu() {
    clear
    echo -e "${CYAN}[*] Searchsploit Search${NC}"
    echo -e "${CYAN}──────────────────────${NC}"
    
    if ! command -v searchsploit &> /dev/null; then
        echo -e "${RED}[!] Searchsploit not found!${NC}"
        echo -e "${YELLOW}[*] Would you like to install Exploit-DB? (y/n): "${NC}
        read -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            install_searchsploit
        else
            exploit_menu
            return
        fi
    fi
    
    read -p "$(echo -e ${YELLOW}"[?] Enter search term: "${NC})" search_term
    
    if [ -z "$search_term" ]; then
        echo -e "${RED}[!] Search term cannot be empty!${NC}"
        return
    fi
    
    print_status "Searching with searchsploit for: $search_term" "info"
    
    # Create results directory
    timestamp=$(date +"%Y%m%d_%H%M%S")
    result_dir="$RESULTS_DIR/searchsploit_${search_term// /_}_${timestamp}"
    mkdir -p "$result_dir"
    
    # Run searchsploit
    searchsploit_search "$search_term" "$result_dir"
    
    echo -e "\n${GREEN}[+] Searchsploit search completed!${NC}"
    echo -e "${GREEN}[+] Results saved in: $result_dir/searchsploit_results.txt${NC}"
    
    read -p "$(echo -e ${YELLOW}"[?] Press Enter to continue..."${NC})"
    exploit_menu
}

# Function to search exploits
search_exploits() {
    local service="$1"
    local result_dir="$2"
    
    {
        echo "EXPLOIT SEARCH RESULTS FOR: $service"
        echo "====================================="
        echo "Search Date: $(date)"
        echo ""
        
        # Try to search using different methods
        echo "1. Searching Exploit-DB..."
        echo "--------------------------"
        if command -v searchsploit &> /dev/null; then
            searchsploit "$service" --exclude="/dos/" | head -30
        else
            echo "Searchsploit not installed"
        fi
        
        echo ""
        echo "2. Searching Metasploit modules..."
        echo "---------------------------------"
        if command -v msfconsole &> /dev/null; then
            msfconsole -q -x "search $service; exit" 2>/dev/null | grep -A 10 "Matching Modules"
        else
            echo "Metasploit not installed"
        fi
        
        echo ""
        echo "3. Online Resources:"
        echo "-------------------"
        echo "Exploit-DB: https://www.exploit-db.com/search?q=$service"
        echo "Rapid7: https://www.rapid7.com/db/?q=$service"
        echo "Packet Storm: https://packetstormsecurity.com/search/?q=$service"
        
    } > "$result_dir/exploits.txt"
}

# Function to search CVE exploits
search_cve_exploits() {
    local cve="$1"
    local result_dir="$2"
    
    {
        echo "CVE EXPLOIT SEARCH RESULTS FOR: $cve"
        echo "====================================="
        echo "Search Date: $(date)"
        echo ""
        
        # Try different search methods
        echo "1. Searchsploit results:"
        echo "------------------------"
        if command -v searchsploit &> /dev/null; then
            searchsploit "$cve"
        else
            echo "Searchsploit not installed"
        fi
        
        echo ""
        echo "2. Online Resources:"
        echo "-------------------"
        echo "NVD: https://nvd.nist.gov/vuln/detail/$cve"
        echo "Exploit-DB: https://www.exploit-db.com/search?cve=$cve"
        echo "MITRE: https://cve.mitre.org/cgi-bin/cvename.cgi?name=$cve"
        echo "Rapid7: https://www.rapid7.com/db/vulnerabilities/$cve"
        
        echo ""
        echo "3. Additional Information:"
        echo "-------------------------"
        echo "To search manually, use:"
        echo "- Google: site:github.com $cve exploit"
        echo "- GitHub: https://github.com/search?q=$cve+exploit"
        echo "- Twitter: https://twitter.com/search?q=$cve"
        
    } > "$result_dir/cve_exploits.txt"
}

# Function to check Metasploit modules
check_metasploit_modules() {
    local app_name="$1"
    local result_dir="$2"
    
    {
        echo "METASPLOIT MODULES FOR: $app_name"
        echo "================================"
        echo "Search Date: $(date)"
        echo ""
        
        if command -v msfconsole &> /dev/null; then
            echo "Searching Metasploit database..."
            echo "------------------------------"
            
            # Create a temporary script for msfconsole
            temp_script=$(mktemp)
            cat > "$temp_script" << EOF
search name:$app_name
exit
EOF
            
            msfconsole -q -r "$temp_script" 2>/dev/null | tee -a "$result_dir/metasploit_modules.txt"
            
            rm "$temp_script"
        else
            echo "Metasploit Framework is not installed"
            echo ""
            echo "To install Metasploit:"
            echo "1. Visit: https://www.metasploit.com/"
            echo "2. Or install via:"
            echo "   - Linux: curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall"
            echo "   - chmod 755 msfinstall"
            echo "   - ./msfinstall"
        fi
        
        echo ""
        echo "Common Metasploit commands for $app_name:"
        echo "----------------------------------------"
        echo "use exploit/path/to/module"
        echo "set RHOSTS target_ip"
        echo "set RPORT target_port"
        echo "set LHOST your_ip"
        echo "set LPORT your_port"
        echo "exploit"
        
    } > "$result_dir/metasploit_modules.txt"
}

# Function to install searchsploit
install_searchsploit() {
    echo -e "${CYAN}[*] Installing Exploit-DB/Searchsploit...${NC}"
    
    if [ -d "/data/data/com.termux/files/usr" ]; then
        # Termux
        pkg update && pkg upgrade -y
        pkg install git -y
        git clone https://github.com/offensive-security/exploitdb.git /data/data/com.termux/files/usr/share/exploitdb
        ln -sf /data/data/com.termux/files/usr/share/exploitdb/searchsploit /data/data/com.termux/files/usr/bin/searchsploit
    else
        # Linux
        sudo apt update
        sudo apt install exploitdb -y
    fi
    
    if command -v searchsploit &> /dev/null; then
        echo -e "${GREEN}[✓] Searchsploit installed successfully${NC}"
    else
        echo -e "${RED}[!] Failed to install searchsploit${NC}"
    fi
}

# Function to run searchsploit search
searchsploit_search() {
    local search_term="$1"
    local result_dir="$2"
    
    {
        echo "SEARCHSPLOIT RESULTS FOR: $search_term"
        echo "======================================"
        echo "Search Date: $(date)"
        echo ""
        
        if command -v searchsploit &> /dev/null; then
            searchsploit "$search_term" --exclude="/dos/" | head -50
        else
            echo "Searchsploit not available"
        fi
        
        echo ""
        echo "Tip: Use 'searchsploit -m <path>' to copy exploit to current directory"
        echo "Example: searchsploit -m exploits/php/webapps/12345.php"
        
    } > "$result_dir/searchsploit_results.txt"
}
